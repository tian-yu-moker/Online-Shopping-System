<!--
@author: Tian Yu 17722024
@Time: 2020.10.20
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Administrator</title>
    <link rel="shortcut icon" href="../media/logos.ico" />
    <link rel="stylesheet" href="../assets/plugins/layui-v2.5.6/layui/layui.css" media="all">
    <script src="../assets/plugins/layui-v2.5.6/layui/layui.js"></script>
    <script type="text/javascript" src="../assets/plugins/jquery-3.3.1.js"></script>
    <script type="text/javascript" src="../assets/plugins/semantic/semantic.js"></script>
    <link rel="stylesheet" type="text/css" href="../assets/plugins/semantic/semantic.css">
    <script type="text/javascript" src="../js/JumpBrandPage.js"></script>
    <script type="text/javascript" src="../js/AllUrlsJson.js"></script></head>
</head>


<body>
<div class="ui fluid container">
    <div class="ui top inverted menu">
        <div class="ui item">
            <img src="../media/logos.ico">
        </div>
        <a class="item" href="MainPage.html">
            <i class="globe icon"></i>
            Main Page
        </a>
        <a class="item" href="ShopCart.html">
            <i class="cart icon"></i>
            Shopping Cart
        </a>
        <a class="item" href="OrderList.html">
            <i class="file alternate icon"></i>
            Order List
        </a>
        <a class="item" href="Administrator.html">
            <i class="user secret icon"></i>
            Administrator
        </a>
        <div class="right menu">
            <div class="item">
                <img class="ui avatar image" id="user_header_menu_icon" src="">
                <a class="text" id="user_menu_name" href="ModifyUserInfo.html">Username</a>
            </div>
            <a class="item" href="Login.html">
                <i class="logout icon"></i>
                Logout
            </a>
        </div>
    </div>
    <div class="ui equal width grid">
        <div class="column"></div>
        <div class="twelve wide column">
            <div class="ui fluid center aligned container">
                <div class="ui statistic">
                    <div class="value">
                        <i class="user secret icon"></i>
                        Administrator
                    </div>
                </div>
            </div>
            <br>
            <div class="ui fluid container">
                <div class="ui fluid segment" style="width: 100%; height: 700px; background-color: whitesmoke; overflow-y:scroll">
                    <table id="administrator_table" lay-filter="administrator_table"></table>
                </div>
            </div>
        </div>
        <div class="column"></div>
    </div>
    <div class="footer">
        <div class="ui center aligned container">
            <div class="ui horizontal small divided link list">
                <a class="item"><img src="../media/logos.ico" class="ui centered mini image"></a>
                <a class="item" href="#" onclick="window.location.href='homepage.html'">
                    <strong style="color: black">About Us</strong>
                </a>
                <a class="item" href="#" onclick="window.location.href='UseragreementsUnique.html'">
                    <strong style="color: black">Privacy Policy</strong>
                </a>
                <div class="item" style="color: black">
                    &nbspÂ©&nbsp Copyright 2020 DS Group 4
                </div>
            </div>
        </div>
    </div>
</div>

<div class="ui small modal" id="admin_details_modal">
    <div class="header">
        <i class="file alternate outline icon"></i>
        Product Detail
    </div>
    <div class="ui grid">
        <div class="four wide column">
            <div class='black card' id="admin_card"onmouseover='modal_card_animation(this)' onmouseleave='onRemove()'>
                <img src="2.png">
            </div>
        </div>
        <div class="one wide column"></div>
        <div class="eleven wide column">
            <div class="ui bulleted list">
                <div class="item" id="product_name" style="font-size: 20px">
                </div>
                <div class="item" id="product_sn" style="font-size: 20px">
                </div>
            </div>
            <form class="ui numberAdmin form">
                <div class="field" style="width: 50%;">
                    <label>Add Number</label>
                    <div class="ui right labeled left icon input">
                        <i class="bookmark outline icon"></i>
                        <input type="text" id="modal_number" name="modal_number" placeholder="Number" value="">
                        <a class="ui primary tag label button" id="modify_number">
                            Modify
                        </a>
                    </div>
                </div>
            </form>
            <br>
            <form class="ui priceAdmin form">
                <div class="field" style="width: 50%;">
                    <label>Product Price</label>
                    <div class="ui right labeled left icon input">
                        <i class="credit card icon"></i>
                        <input type="text" id="modal_price" placeholder="Price" value="">
                        <a class="ui primary tag label button" id="modify_price" name="modify_price">
                            Modify
                        </a>
                    </div>
                </div>
            </form>
            <br>
        </div>
    </div>
    <div class="actions">
        <div class="ui positive right labeled icon button">
            OK
            <i class="checkmark icon"></i>
        </div>
    </div>
</div>

<div class="ui mini modal" id="error_message_admin">
    <div class="header">
        <i class="x icon"></i>
        <strong>Message</strong>
    </div>
    <div class="content">
        <div class="content">
            <p>Wrong product number of price.</p>
            <p>Please enter a valid number</p>
        </div>
    </div>
    <div class="actions">
        <div class="ui negative right labeled icon red button">
            OK
            <i class="checkmark icon"></i>
        </div>
    </div>
</div>

<div class="ui mini modal" id="confirm_message_admin_number">
    <div class="header">
        <i class="checkmark icon"></i>
        <strong>Message</strong>
    </div>
    <div class="content">
        <div class="content">
            <p>Modify this product?</p>
        </div>
    </div>
    <div class="actions">
        <div class="ui positive right labeled icon red button">
            OK
            <i class="checkmark icon"></i>
        </div>
    </div>
</div>

<div class="ui mini modal" id="confirm_message_admin_price">
    <div class="header">
        <i class="checkmark icon"></i>
        <strong>Message</strong>
    </div>
    <div class="content">
        <div class="content">
            <p>Modify this product?</p>
        </div>
    </div>
    <div class="actions">
        <div class="ui positive right labeled icon red button">
            OK
            <i class="checkmark icon"></i>
        </div>
    </div>
</div>

</body>

<script type="text/html" id="toolbarAdmin">
    <a href="#" onclick="window.location.href='AdministratorUserManagement.html'">
        <i class="users icon"></i>
        All Users Management
    </a>
</script>

<script type="text/html" id="adminToolBar">
    <a class="layui-btn layui-btn-xs" lay-event="showDetails">Show Details</a>
</script>

<script>
    let allGoods = [];
    let isNumberOpen = false;
    let isPriceOpen = false;
    let userInfo;
    window.onload = function ()
    {
        userInfo = JSON.parse(sessionStorage.getItem('userInfo'));

        if(JSON.parse(sessionStorage.getItem('IconPath')).hasIcon == '1')
            $('#user_header_menu_icon').attr('src', urlJson.url_major + urlJson.PictureDownload + "?email=" + userInfo.email);
        else if(JSON.parse(sessionStorage.getItem('IconPath')).hasIcon == '0')
            $('#user_header_menu_icon').attr('src', userInfo.userIconPath);

        $('#user_menu_name').html(userInfo.userName);
        let sessionData = JSON.parse(sessionStorage.getItem('allProductsDataForAdmin'));
        loadTableData(sessionData);
        layui.use('table', function()
        {
            let table = layui.table;
            table.render({
                elem: '#administrator_table'
                ,toolbar: '#toolbarAdmin'
                ,defaultToolbar: [
                    {
                        title: 'Print'
                        ,layEvent: 'LAYTABLE_PRINT'
                        ,icon: 'layui-icon-print'
                    },
                    {
                        title: 'Select'
                        ,layEvent: 'LAYTABLE_COLS'
                        ,icon: 'layui-icon-cols'
                    },
                    {
                        title: 'Export'
                        ,layEvent: 'LAYTABLE_EXPORT'
                        ,icon: 'layui-icon-export'
                    }
                ]
                ,cols: [[
                    {field: 'goods_id', title: 'ID', width: 80, align: 'center', sort: true}
                    ,{field: 'goods_sn', title: 'Sn Code', width: 150, align: 'center', sort: true}
                    ,{field: 'goods_name', title: 'Name', minWidth: 150,align: 'center'}
                    ,{field: 'goods_count', title: 'Number', width: 200, align: 'center', sort: true}
                    ,{field: 'price', title: 'Price(Pounds)', width: 200, align: 'center', sort: true}
                    ,{field: 'right', title:'Operation', toolbar: '#adminToolBar', width:200, align: 'center'}
                ]]
                ,data: allGoods
                ,limit: 40
                ,skin: 'line'
                ,even: true
            });

            /*
            Listener of the table rows
             */
            table.on('tool(administrator_table)', function(obj){
                if(obj.event === 'showDetails')
                {
                    console.log(obj.data);
                    let path = "../media/BrandImages/" + obj.data.goods_sn + ".png";
                    $('#admin_card').children('img').attr('src', path);
                    $('#product_name').html("Product name:&nbsp;" + obj.data.goods_name);
                    $('#product_sn').html("Product Sn:&nbsp;" + obj.data.goods_sn);
                    $('#modal_price').val(obj.data.price);
                    $('#modal_number').val(obj.data.goods_count);
                    let targetData;
                    $('#admin_details_modal').modal(
                        {
                            onVisible: function ()
                            {
                                $('#modify_number').click(function()
                                {
                                    $('.numberAdmin').form
                                    (
                                        {
                                            fields: {
                                                modal_number: {
                                                    identifier: 'modal_number',
                                                    rules: [
                                                        {
                                                            type: 'empty',
                                                            prompt: 'Please enter a number'
                                                        }
                                                    ]
                                                }
                                            }
                                        }
                                    );
                                    let isValid = $('.numberAdmin').form('is valid', 'modal_number');
                                    if(!isValid)
                                        $('#error_message_admin').modal('show');
                                    else
                                    {
                                        $('#confirm_message_admin_number').modal('show');
                                        targetData = $('#modal_number').val();
                                    }
                                });

                                $('#modify_price').click(function()
                                {
                                    $('.priceAdmin').form
                                    (
                                        {
                                            fields: {
                                                modal_price: {
                                                    identifier: 'modal_price',
                                                    rules: [
                                                        {
                                                            type: 'empty',
                                                            prompt: 'Please enter a price'
                                                        }
                                                    ]
                                                }
                                            }
                                        }
                                    );
                                    let isValid = $('.priceAdmin').form('is valid', 'modal_price');
                                    if(!isValid)
                                        $('#error_message_admin').modal('show');
                                    else
                                    {
                                        $('#confirm_message_admin_price').modal('show');
                                        targetData = $('#modal_price').val();
                                    }
                                });
                            }
                        }
                    ).modal('show');

                    $('#confirm_message_admin_number').modal
                    (
                        {
                            onApprove: function ()
                            {
                                let goods_sn = obj.data.goods_sn;
                                console.log(goods_sn + " " + targetData)
                                let count = obj.data.goods_count;
                                let isSuccess = queryAdministrator("modal_number", goods_sn, targetData);
                                let currentCount = Number(count) + Number(targetData);
                                if(isSuccess)
                                {
                                    layer.msg('Success!', {
                                        time: 2000,
                                    });
                                    obj.update({
                                        goods_count: currentCount
                                    });
                                }
                                else
                                {
                                    layer.msg('Some Error!', {
                                        time: 2000,
                                    });
                                }
                            }
                        }
                    );

                    $('#confirm_message_admin_price').modal
                    (
                        {
                            onApprove: function ()
                            {
                                let goods_sn = obj.data.goods_sn;
                                let isSuccess = queryAdministrator("modal_price", goods_sn, targetData);
                                if(isSuccess)
                                {
                                    layer.msg('Success!', {
                                        time: 2000,
                                    });
                                    obj.update({
                                        price: targetData,
                                    });
                                }
                                else
                                {
                                    layer.msg('Some Error!', {
                                        time: 2000,
                                    });
                                }
                            }
                        }
                    );
                }
            });
        });
    }

    /*
    Load all the data of the table
    */
    function loadTableData(sessionData)
    {
        let allRecords = sessionData.all;
        let length = allRecords.length;
        for(let i = 0; i < length; i++)
        {
            let oneRecord;
            console.log(allRecords[i].goods_id);
            oneRecord = {
                "goods_id": allRecords[i].goods_id.toString(),
                "goods_sn": allRecords[i].goods_sn,
                "goods_name": allRecords[i].goods_name,
                "goods_count": allRecords[i].goods_count,
                "price": allRecords[i].price,
                "description": allRecords[i].description
            }
            allGoods.push(oneRecord);
        }
    }

    /*
    Query API Service
     */
    function queryAdministrator(val, good_sn, value)
    {
        let urlMajor;
        let urlAddition;
        let submitData;
        let returnData = false;

        if(val == "modal_number")
        {
            urlMajor = urlJson.url_major + urlJson.AdministratorNumber;
            urlAddition = urlJson.url_addition + urlJson.AdministratorNumber;
            submitData = {
                "goods_sn": good_sn,
                "goods_amount": value
            };
            submitData = JSON.stringify(submitData);
        }
        else if(val == "modal_price")
        {
            urlMajor = urlJson.url_major + urlJson.AdministratorPrice;
            urlAddition = urlJson.url_addition + urlJson.AdministratorPrice;
            submitData = {
                "goods_sn": good_sn,
                "price": value
            };
            submitData = JSON.stringify(submitData);
        }

        console.log(submitData + "123123");

        let query = $.ajax({
            url: urlMajor,
            type: 'POST',
            data: submitData,
            timeout: 2000,
            dateType: "json",
            async: false,
            success: function (res,status,xhr)
            {
                let response = JSON.parse(res);
                if(xhr.status == 200)
                {
                    if(response.status == "00")
                        returnData = true;
                }
            },
            fail: function(res)
            {
                console.log(res)
            },
            error: function(res)
            {
                let queryAddition = $.ajax({
                    url: urlAddition,
                    type: 'POST',
                    data: submitData,
                    timeout: 2000,
                    dateType: "json",
                    async: false,
                    success: function (res, status,xhr)
                    {
                        let response = JSON.parse(res);
                        if(xhr.status == 200)
                        {
                            if(response.status == "00")
                                returnData = true;
                        }
                    },
                    fail: function(res)
                    {
                        console.log(res);
                    },
                    error: function(res)
                    {
                        console.log(res);
                    }
                });
            },
            complete : function(XMLHttpRequest,status)
            {
                console.log(status);
                if(status == 'timeout')
                {
                    query.abort();
                    alert("Time out!");
                }
            }
        });
        return returnData;
    }

    let isHover = false;
    function onRemove(val)
    {
        isHover = false;
    }

    function modal_card_animation(val)
    {
        if(!isHover)
        {
            isHover = true;
            let animationType = "pulse";
            $(val).transition({
                animation : animationType,
                duration  : 600,
                interval  : 500
            });
        }
    }
</script>

<style>
    body {
        background-image: url("../media/MainPage/background.png");
        background-repeat:no-repeat;
        background-attachment: fixed;
        background-origin: border-box;
        background-size:cover;
    }
    .footer {
        height: 50px;
        line-height: 50px;

        text-align: center;
        position: fixed;
        right: 0;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 999;
    }
</style>

</html>